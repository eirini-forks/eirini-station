#!/bin/bash

bold=$(printf "\033[1m")
normal=$(printf "\033[0m")
red=$(printf "\033[31m")
yellow=$(printf "\033[33m")

if ! ssh-add -L 2>&1 >/dev/null; then
  echo "${bold}${red}No ssh key is loaded. Please add your ssh key before running this script!${normal}"
  exit 1
fi

readonly GUEST_USERNAME="$(ssh-add -L | cut -d ' ' -f 3 | cut -d @ -f 1)"
readonly SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

USAGE=$(
  cat <<EOF

Usage: pair-connect [options] STATION_ADDRESS
Args:
  STATION_ADDRESS  address of station to connect to. Required. Ask your pair to run 'pssh' on their station and send you the output.
Options:
  -p               ssh port of the station's sshd. Optional. Default is 22. This is required if using ngrok.
  -i               install pair-connect in /usr/local/bin as a symlink
  -h               this help
EOF
)

connect() {
  local station_address host_username port
  station_address="$1"
  port="$2"
  host_username="$(echo $station_address | awk -F '@' '{print $1}')"

  ssh -A -R /home/"$host_username"/.gnupg/S.gpg-agent-"$GUEST_USERNAME":$HOME/.gnupg/S.gpg-agent -p "$port" "$station_address"
}

main() {
  local station_address station_port
  station_address=""
  station_port=""
  ARGS=()
  while [ $# -gt 0 ]; do
    unset OPTIND
    unset OPTARG
    while getopts "iha:p:" opt; do
      case ${opt} in
        h)
          print-logo
          echo "$USAGE"
          exit 0
          ;;
        i)
          if [[ -L /usr/local/bin/pair-connect ]]; then
            echo "${bold}${yellow}pair-connect already installed in /usr/local/bin!"
            exit 1
          fi
          sudo ln -s "$SCRIPT_DIR/pair-connect" /usr/local/bin/pair-connect
          exit "$?"
          ;;
        p)
          station_port="$OPTARG"
          ;;
        \?)
          echo "${bold}${red}Invalid option: ${OPTARG}${normal}" 1>&2
          print-logo
          echo "$USAGE"
          exit 1
          ;;
        :)
          echo "${bold}${red}Invalid option: $OPTARG requires an argument${normal}" 1>&2
          print-logo
          echo "$USAGE"
          exit 1
          ;;
      esac
    done
    shift $((OPTIND - 1))
    ARGS+=("$1")
    shift
  done

  station_address="${ARGS[0]}"
  if [[ -z "$station_address" ]]; then
    echo "${bold}${red}Station address is required to connect.${normal}"
    echo "${bold}${red}Please supply the address of the station that you want to connect to!${normal}"
    echo "${bold}${red}Ask your pair to run 'pssh' on their station and send you the output.${normal}"
    echo
    echo "$USAGE"
    exit 1
  fi

  connect "$station_address" "$station_port"
}

print-logo() {
  cat <<-"EOF"

                    [38;m#[38;5;058m%
           [38;5;065m#[38;5;071m([38;5;071m([38;5;071m([38;5;071m([38;5;065m## ([38;5;058m%((
         #[38;5;065m#[38;5;107m([38;5;107m([38;5;107m([38;5;071m([38;5;071m([38;5;065m#[38;5;064m#[38;5;148m/[38;5;148m/[38;5;148m/[38;5;148m/[38;5;148m/[38;5;148m/[38;5;142m/[38;5;142m/[38;5;106m(
         [38;5;065m([38;5;107m([38;5;107m([38;5;107m([38;5;107m([38;5;065m#[38;5;065m([38;5;185m*[38;5;185m*[38;5;185m*[38;5;185m*[38;5;185m*[38;5;185m*[38;5;149m*[38;5;148m/[38;5;148m/[38;5;148m/[38;5;142m/[38;5;106m(
        [38;5;065m([38;5;065m((   *[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m*[38;5;185m*[38;5;185m*[38;5;149m*[38;5;149m/[38;5;148m/[38;5;106m(
             *[38;5;149m*[38;5;186m,[38;5;186m,[38;5;186m,[38;5;186m,[38;5;186m,[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m*[38;5;185m*[38;5;185m*[38;5;149m*[38;5;148m/[38;5;106m(
            *[38;5;149m*[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;186m,[38;5;186m,[38;5;185m,[38;5;185m,[38;5;185m*[38;5;185m*[38;5;185m*[38;5;149m/[38;5;148m/[38;5;106m(
           [38;5;149m*[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;186m,[38;5;186m,[38;5;185m,[38;5;185m,[38;5;185m*[38;5;185m*[38;5;149m*[38;5;148m/[38;5;148m/[38;5;106m(
         *[38;5;149m*[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;186m,[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m*[38;5;185m*[38;5;149m/[38;5;148m/[38;5;148m/[38;5;142m/[38;5;106m((
         [38;5;149m*[38;5;186m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;192m,[38;5;186m,[38;5;186m,[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m*[38;5;185m*[38;5;149m*[38;5;148m/[38;5;148m/[38;5;142m/[38;5;142m/[38;5;142m/[38;5;106m(
        [38;5;143m/[38;5;185m,[38;5;185m,[38;5;186m,[38;5;186m,[38;5;186m,[38;5;186m,[38;5;186m,[38;5;186m,[38;5;186m,[38;5;186m,[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m*[38;5;185m*[38;5;185m*[38;5;149m*[38;5;148m/[38;5;148m/[38;5;142m/[38;5;142m/[38;5;142m/[38;5;142m/[38;5;106m(
        /[38;5;185m*[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m,[38;5;185m*[38;5;185m*[38;5;185m*[38;5;149m*[38;5;148m/[38;5;148m/[38;5;148m/[38;5;142m/[38;5;142m/[38;5;142m/[38;5;142m/[38;5;142m/[38;5;106m(
         [38;5;143m/[38;5;185m*[38;5;185m*[38;5;185m*[38;5;185m*[38;5;185m*[38;5;185m*[38;5;185m*[38;5;185m*[38;5;185m*[38;5;185m*[38;5;149m*[38;5;149m/[38;5;148m/[38;5;148m/[38;5;148m/[38;5;142m/[38;5;142m/[38;5;142m/[38;5;142m/[38;5;142m/[38;5;142m/[38;5;106m(
           [38;5;142m([38;5;148m/[38;5;148m/[38;5;148m/[38;5;148m/[38;5;148m/[38;5;148m/[38;5;148m/[38;5;148m/[38;5;148m/[38;5;148m/[38;5;142m/[38;5;142m/[38;5;142m/[38;5;142m/[38;5;142m/[38;5;142m/[38;5;142m/[38;5;106m(
               [38;5;106m([38;5;106m([38;5;106m([38;5;106m([38;5;142m([38;5;142m([38;5;142m([38;5;142m([38;5;106m([38;5;106m([38;5;106m((
[0m
   ___       _       _____                       __
  / _ \___ _(_)___  / ___/__  ___  ___  ___ ____/ /_
 / ___/ _ `/ / __/ / /__/ _ \/ _ \/ _ \/ -_) __/ __/
/_/   \_,_/_/_/    \___/\___/_//_/_//_/\__/\__/\__/
EOF
}

main "$@"
